#!/usr/bin/execlineb -P
define PREFIX "[oneshot] certs:"

define C000 "\033[0m"
define C030 "\033[0;30m"
define C031 "\033[0;31m"
define C032 "\033[0;32m"
define C033 "\033[0;33m"
define C034 "\033[0;34m"
define C035 "\033[0;35m"
define C036 "\033[0;36m"
define C037 "\033[0;37m"
define C130 "\033[1;30m"
define C131 "\033[1;31m"
define C132 "\033[1;32m"
define C133 "\033[1;33m"
define C134 "\033[1;34m"
define C135 "\033[1;35m"
define C136 "\033[1;36m"
define C137 "\033[1;37m"

foreground {
  s6-echo "${PREFIX} ${C032}begin generating certs${C000}"
}
foreground {
  if -n {
    ls /etc/pulp/certs
  }
  mkdir -p /etc/pulp/certs
}
if -n -x 0 {
  ls /etc/pulp/certs/token_private_key.pem
}
foreground {
  openssl ecparam -genkey -name prime256v1 -noout -out /etc/pulp/certs/token_private_key.pem
}
foreground {
  openssl ec -in /etc/pulp/certs/token_private_key.pem -pubout -out /etc/pulp/certs/token_public_key.pem
}
foreground {
  openssl genrsa -out /etc/pulp/certs/pulp_webserver.key 2048
}
foreground {
  openssl req -new -key /etc/pulp/certs/pulp_webserver.key -subj "/CN=pulp/C=US/ST=NC/L=Raleigh/O=Red Hat, Inc./OU=pnt" -out /etc/pulp/certs/pulp_webserver.csr -extensions v3_req -config /etc/ssl/pulp/openssl.cnf
}
foreground {
  openssl x509 -req -days 365 -in /etc/pulp/certs/pulp_webserver.csr -signkey /etc/pulp/certs/pulp_webserver.key -out /etc/pulp/certs/pulp_webserver.crt -extensions v3_req -extfile /etc/ssl/pulp/v3.cnf
}
foreground {
  cp /etc/pulp/certs/pulp_webserver.crt /etc/pki/tls/certs/pulp_webserver.crt
}
foreground {
  cp /etc/pulp/certs/pulp_webserver.csr /etc/pki/tls/private/pulp_webserver.csr
}
foreground {
  cp /etc/pulp/certs/pulp_webserver.key /etc/pki/tls/private/pulp_webserver.key
}
foreground {
  update-ca-trust force-enable
}
foreground {
  update-ca-trust extract
}
foreground {
  pipeline {
    cat /etc/pulp/certs/pulp_webserver.crt
  }
  tee -a /etc/pki/tls/cert.pem
}
foreground {
   s6-echo "${PREFIX} ${C032}finish generating certs${C000}"
}
